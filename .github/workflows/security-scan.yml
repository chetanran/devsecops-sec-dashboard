name: Security Scan

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  python-security:
    name: Python Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Run Python security scans
        run: bash scripts/scan-python-security.sh
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-reports
          path: backend/*-report.json
          retention-days: 30

  npm-security:
    name: NPM Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Run NPM security scans
        run: bash scripts/scan-npm-security.sh
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-reports
          path: frontend/*-report.json
          retention-days: 30

  semgrep-sast:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Run Semgrep SAST
        run: bash scripts/scan-semgrep.sh
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-report
          path: semgrep-report.json
          retention-days: 30

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        run: bash scripts/scan-gitleaks.sh
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [python-security, npm-security, semgrep-sast, secret-scanning]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Parse and create summary
        run: |
          # Parse Python reports
          PIP_AUDIT_COUNT=0
          BANDIT_COUNT=0

          if [ -f python-reports/pip-audit-report.json ]; then
            PIP_AUDIT_COUNT=$(jq -r '[.dependencies[]? | select(.vulns | length > 0)] | length // 0' python-reports/pip-audit-report.json 2>/dev/null || echo 0)
          fi

          if [ -f python-reports/bandit-report.json ]; then
            BANDIT_COUNT=$(jq -r '.results | length // 0' python-reports/bandit-report.json 2>/dev/null || echo 0)
          fi

          # Parse NPM reports
          NPM_CRITICAL=0
          NPM_HIGH=0
          NPM_MODERATE=0
          NPM_LOW=0

          if [ -f npm-reports/npm-audit-report.json ]; then
            NPM_CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
            NPM_HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
            NPM_MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
            NPM_LOW=$(jq -r '.metadata.vulnerabilities.low // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
          fi

          # Parse Semgrep report
          SEMGREP_TOTAL=0
          SEMGREP_ERROR=0
          SEMGREP_WARNING=0
          if [ -f semgrep-report/semgrep-report.json ]; then
            SEMGREP_TOTAL=$(jq -r '.results | length // 0' semgrep-report/semgrep-report.json 2>/dev/null || echo 0)
            SEMGREP_ERROR=$(jq -r '[.results[] | select(.extra.severity == "ERROR")] | length // 0' semgrep-report/semgrep-report.json 2>/dev/null || echo 0)
            SEMGREP_WARNING=$(jq -r '[.results[] | select(.extra.severity == "WARNING")] | length // 0' semgrep-report/semgrep-report.json 2>/dev/null || echo 0)
          fi

          # Parse Gitleaks report
          SECRETS_COUNT=0
          if [ -f gitleaks-report/gitleaks-report.json ]; then
            SECRETS_COUNT=$(jq -r '. | length // 0' gitleaks-report/gitleaks-report.json 2>/dev/null || echo 0)
          fi

          # Calculate totals
          NPM_TOTAL=$((NPM_CRITICAL + NPM_HIGH + NPM_MODERATE + NPM_LOW))

          # Create summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”’ Security Scan Results

          ### ðŸ“Š Job Status
          | Job | Status |
          |-----|--------|
          | Python Security | ${{ needs.python-security.result }} |
          | NPM Security | ${{ needs.npm-security.result }} |
          | Semgrep SAST | ${{ needs.semgrep-sast.result }} |
          | Secret Scanning | ${{ needs.secret-scanning.result }} |

          ### ðŸ Python Security Findings
          | Tool | Findings |
          |------|----------|
          | pip-audit | ${PIP_AUDIT_COUNT} vulnerable packages |
          | Bandit (SAST) | ${BANDIT_COUNT} code issues |

          ### ðŸ“¦ NPM Security Findings
          | Severity | Count |
          |----------|-------|
          | Critical | ${NPM_CRITICAL} |
          | High | ${NPM_HIGH} |
          | Moderate | ${NPM_MODERATE} |
          | Low | ${NPM_LOW} |
          | **Total** | **${NPM_TOTAL}** |

          ### ðŸ” Semgrep SAST Findings
          | Category | Count |
          |----------|-------|
          | Total Findings | ${SEMGREP_TOTAL} |
          | Error Severity | ${SEMGREP_ERROR} |
          | Warning Severity | ${SEMGREP_WARNING} |

          ### ðŸ” Secret Scanning Findings
          | Tool | Findings |
          |------|----------|
          | Gitleaks | ${SECRETS_COUNT} potential secrets |

          ### ðŸ“¥ Artifact Downloads
          - **python-reports**: pip-audit, bandit JSON reports
          - **npm-reports**: npm-audit JSON report
          - **semgrep-report**: semgrep SAST JSON report
          - **gitleaks-report**: gitleaks JSON report

          All artifacts retained for 30 days.
          EOF
