name: Security Scan

on:
  push:
    branches: [setghubaction]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  python-security:
    name: Python Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Run Python security scans
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt pip-audit bandit safety
          cd backend

          # pip-audit
          pip-audit --requirement requirements.txt --format json --output pip-audit-report.json 2>&1 || echo '{"dependencies":[],"vulnerabilities":[]}' > pip-audit-report.json

          # bandit
          bandit -r . -f json -o bandit-report.json 2>&1 || echo '{"results":[],"metrics":{"_totals":{"CONFIDENCE.HIGH":0,"SEVERITY.HIGH":0}}}' > bandit-report.json

          # safety (skip if fails - requires API key)
          safety check --json --output safety-report.json 2>&1 || echo '{"report_meta":{},"scanned_packages":[],"affected_packages":[],"announcements":[]}' > safety-report.json
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-reports
          path: backend/*-report.json
          retention-days: 30

  npm-security:
    name: NPM Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Run NPM security scans
        run: |
          cd frontend
          npm install --legacy-peer-deps

          # npm audit - exit code 0 even with vulnerabilities for proper JSON output
          npm audit --json --audit-level=none > npm-audit-report.json 2>&1 || true

          # Ensure valid JSON even if npm audit failed
          if [ ! -s npm-audit-report.json ] || ! jq empty npm-audit-report.json 2>/dev/null; then
            echo '{"vulnerabilities":{},"metadata":{"vulnerabilities":{"info":0,"low":0,"moderate":0,"high":0,"critical":0}}}' > npm-audit-report.json
          fi

          # retire.js
          npx retire --outputformat json --outputpath retire-report.json 2>&1 || echo '[]' > retire-report.json
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-reports
          path: frontend/*-report.json
          retention-days: 30

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.2_linux_x64.tar.gz
          ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json --no-git || echo '[]' > gitleaks-report.json
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [python-security, npm-security, secret-scanning]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Parse and create summary
        run: |
          # Parse Python reports
          PIP_AUDIT_COUNT=0
          BANDIT_COUNT=0
          SAFETY_COUNT=0

          if [ -f python-reports/pip-audit-report.json ]; then
            PIP_AUDIT_COUNT=$(jq -r '.vulnerabilities | length // 0' python-reports/pip-audit-report.json 2>/dev/null || echo 0)
          fi

          if [ -f python-reports/bandit-report.json ]; then
            BANDIT_COUNT=$(jq -r '.results | length // 0' python-reports/bandit-report.json 2>/dev/null || echo 0)
          fi

          if [ -f python-reports/safety-report.json ]; then
            SAFETY_COUNT=$(jq -r '.affected_packages | length // 0' python-reports/safety-report.json 2>/dev/null || echo 0)
          fi

          # Parse NPM reports
          NPM_CRITICAL=0
          NPM_HIGH=0
          NPM_MODERATE=0
          NPM_LOW=0
          RETIRE_COUNT=0

          if [ -f npm-reports/npm-audit-report.json ]; then
            NPM_CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
            NPM_HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
            NPM_MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
            NPM_LOW=$(jq -r '.metadata.vulnerabilities.low // 0' npm-reports/npm-audit-report.json 2>/dev/null || echo 0)
          fi

          if [ -f npm-reports/retire-report.json ]; then
            RETIRE_COUNT=$(jq -r '. | length // 0' npm-reports/retire-report.json 2>/dev/null || echo 0)
          fi

          # Parse Gitleaks report
          SECRETS_COUNT=0
          if [ -f gitleaks-report/gitleaks-report.json ]; then
            SECRETS_COUNT=$(jq -r '. | length // 0' gitleaks-report/gitleaks-report.json 2>/dev/null || echo 0)
          fi

          # Calculate totals
          NPM_TOTAL=$((NPM_CRITICAL + NPM_HIGH + NPM_MODERATE + NPM_LOW))

          # Create summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”’ Security Scan Results

          ### ðŸ“Š Job Status
          | Job | Status |
          |-----|--------|
          | Python Security | ${{ needs.python-security.result }} |
          | NPM Security | ${{ needs.npm-security.result }} |
          | Secret Scanning | ${{ needs.secret-scanning.result }} |

          ### ðŸ Python Security Findings
          | Tool | Findings |
          |------|----------|
          | pip-audit | ${PIP_AUDIT_COUNT} vulnerabilities |
          | Bandit (SAST) | ${BANDIT_COUNT} issues |
          | Safety | ${SAFETY_COUNT} affected packages |

          ### ðŸ“¦ NPM Security Findings
          | Severity | Count |
          |----------|-------|
          | Critical | ${NPM_CRITICAL} |
          | High | ${NPM_HIGH} |
          | Moderate | ${NPM_MODERATE} |
          | Low | ${NPM_LOW} |
          | **Total** | **${NPM_TOTAL}** |
          | retire.js | ${RETIRE_COUNT} vulnerable libraries |

          ### ðŸ” Secret Scanning Findings
          | Tool | Findings |
          |------|----------|
          | Gitleaks | ${SECRETS_COUNT} potential secrets |

          ### ðŸ“¥ Artifact Downloads
          - **python-reports**: pip-audit, bandit, safety JSON reports
          - **npm-reports**: npm-audit, retire.js JSON reports
          - **gitleaks-report**: gitleaks JSON report

          All artifacts retained for 30 days.
          EOF
